# ✅ STEP 20. 장애 대응 설계 보고서 (주문 생성 API)

---

## 🎯 테스트 목적

Kafka 기반 주문 생성 시스템에서 재고 차감 처리 흐름의 병목 지점 및 장애 가능성을 정의하고, 메시지 적체, DLQ, 처리 실패율 등을 기반으로 단기/중기/장기 대응 전략을 수립하여 안정성과 확장성을 확보한다.

---

## ⚠️ 장애 시나리오 정의

| 시나리오 | 설명 | 영향 |
| --- | --- | --- |
| Kafka Consumer 다운 | 재고 차감 미처리 | 주문 처리 완료되었으나 재고 차감 누락 |
| Kafka 메시지 적체 | 주문 트래픽 폭증 | Lag 증가 및 지연 |
| DB 오류 | 주문 저장 실패 | 메시지 미발행 |
| 유효하지 않은 요청 | 재고 부족 / 쿠폰 소진 | 4xx 오류 급증 |
| DLQ 발생 | 차감 실패 메시지 | 보상 로직 필요 |

---

## 📊 지표 기반 장애 징후

- Kafka Consumer Lag: `0` → 정상, 상승 시 처리 적체
- DLQ (`stock.decrease.failed`) 존재 시 차감 실패 발생
- TPS 급증 시 평균 응답 시간 증가
- 평균 응답시간: p90=167ms, p95=197ms
- 실패율 없음 (100% 성공)

---

## 🛠 장애 대응 전략

### ✅ Short-term (즉시 대응)

| 항목 | 조치 |
| --- | --- |
| Kafka Consumer 다운 | Auto Restart, Lag 모니터링 |
| DLQ 메시지 발생 | 로그 확인 후 수동 복구 |
| 주문 트래픽 증가 | 임시 Queue Backpressure 적용 |
| 사용자 오류 | 프론트 유효성 체크 강화, UX 개선 |

### ✅ Mid-term (지속 개선)

| 항목 | 조치 |
| --- | --- |
| Consumer Group 확장 | 병렬 소비로 TPS 대응 |
| DLQ 자동화 | DLQ Consumer 도입 및 재처리 로직 구성 |
| 성능 최적화 | JPA, DB, Kafka 설정 튜닝 |
| 이벤트 검증 | Kafka → Consumer 간 Contract 강화 |

### ✅ Long-term (구조 개선)

| 항목 | 조치 |
| --- | --- |
| 도메인 분리 | 주문/재고/쿠폰 MSA 분리 및 독립 확장 |
| Outbox 패턴 도입 | 주문 → Kafka 메시지 신뢰성 강화 |
| Admin 도구 | DLQ 수동 재처리 UI 구성 |
| 트래픽 예측 | Auto Scaling 및 Sharding 기반 Consumer 구성 |

---

## 🔁 핵심 지표 및 대응 기준

| 지표 | 기준 |
| --- | --- |
| Kafka Consumer Lag | 100 이상 시 경고, 지속되면 DLQ 발생 예상 |
| TPS | 500 이상 시 성능 저하 우려 |
| 응답시간 (p95) | 200ms 이상 지속되면 병목 점검 필요 |
| DLQ 발생 | 실시간 Alert + 복구 루트 필요 |

---

## ✅ 결론

- Kafka 기반 주문-재고 구조는 이벤트 손실 없이 재고 처리까지 가능했음
- 응답 성공률 100% → 사용자 경험은 우수
- 단, Kafka 메시지 소비 속도는 주문 트래픽 대비 병목이 될 수 있음
- DLQ 자동화 및 트래픽 확장 대응 구조 설계가 장기 과제